<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUMARK - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .active { background-color: #4f46e5; color: white; } /* indigo-600 */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen px-4">
        <div class="w-full max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="relative -mt-16 mb-4">
                    <img src="https://i.ibb.co/8nwjS2dr/profile-img.png" alt="Illustration" class="w-full h-auto rounded-t-lg">
                </div>
                 <div class="text-center mb-8">
                    <img src="https://i.ibb.co/mCP7MD6m/image-20250927-120756-0000.png" alt="EDUMARK Logo" class="w-20 h-20 mx-auto mb-4 rounded-full shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800">Admin Login</h2>
                    <p class="text-sm text-gray-500">Welcome back! Please enter your details.</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 w-full px-4 py-3 text-gray-700 bg-gray-100 border-gray-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="you@example.com">
                    </div>
                    <div>
                         <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 w-full px-4 py-3 text-gray-700 bg-gray-100 border-gray-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-semibold rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 transform hover:scale-105">Sign in</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://i.ibb.co/mCP7MD6m/image-20250927-120756-0000.png" alt="EDUMARK Logo" class="h-10 w-10 rounded-full">
                        <span class="ml-3 text-2xl font-bold text-gray-800">EDUMARK</span>
                    </div>
                    <button id="logout-button" class="text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition-colors">Logout</button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Sidebar Navigation -->
                <aside class="w-full lg:w-1/4">
                    <div class="bg-white p-4 rounded-xl shadow-lg">
                        <nav class="space-y-2">
                            <button data-tab="dashboard" class="w-full text-left font-semibold p-3 rounded-lg tab-button active"><i class="fas fa-tachometer-alt w-6 mr-2"></i>Dashboard</button>
                            <button data-tab="students" class="w-full text-left font-semibold p-3 rounded-lg tab-button"><i class="fas fa-user-graduate w-6 mr-2"></i>Student Management</button>
                            <button data-tab="announcements" class="w-full text-left font-semibold p-3 rounded-lg tab-button"><i class="fas fa-bullhorn w-6 mr-2"></i>Announcements</button>
                            <button data-tab="settings" class="w-full text-left font-semibold p-3 rounded-lg tab-button"><i class="fas fa-cog w-6 mr-2"></i>School Settings</button>
                        </nav>
                    </div>
                </aside>
                <!-- Main Content Area -->
                <div class="w-full lg:w-3/4">
                    <!-- Dashboard Tab -->
                    <div id="dashboard-tab" class="tab-content">
                        <div class="border-b pb-4 mb-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
                                    <p class="text-gray-500">Welcome! Here's a summary of the school's performance.</p>
                                </div>
                                <div class="text-right flex-shrink-0">
                                     <p id="current-time" class="text-2xl font-bold text-gray-800"></p>
                                     <p id="current-date" class="text-sm text-gray-500"></p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                           <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-transform transform hover:-translate-y-1">
                                <i class="fas fa-users text-4xl text-blue-500"></i>
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Students</p>
                                    <p id="total-students-card" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-transform transform hover:-translate-y-1">
                                <i class="fas fa-user-check text-4xl text-green-500"></i>
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Number of Pass</p>
                                    <p id="passed-students-card" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-transform transform hover:-translate-y-1">
                                <i class="fas fa-user-times text-4xl text-red-500"></i>
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Number of Fail</p>
                                    <p id="failed-students-card" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Student Management Tab -->
                    <div id="students-tab" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg">
                        <div class="border-b pb-4 mb-6">
                            <h2 id="student-form-title" class="text-2xl font-bold text-gray-800">Add New Student & Results</h2>
                            <p class="text-gray-500">Fill in the details to add or update a student and their marks.</p>
                        </div>
                        <form id="student-result-form" class="space-y-6">
                             <!-- Student Details -->
                            <input type="hidden" id="student-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label><input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div>
                                <div><label for="father-name" class="block text-sm font-medium text-gray-700">Father's Name</label><input type="text" id="father-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div>
                                <div><label for="roll-number" class="block text-sm font-medium text-gray-700">Roll Number</label><input type="text" id="roll-number" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div>
                                <div><label for="student-class" class="block text-sm font-medium text-gray-700">Class</label><input type="text" id="student-class" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div>
                                <div class="md:col-span-2"><label for="student-photo-url" class="block text-sm font-medium text-gray-700">Student Photo URL</label><input type="url" id="student-photo-url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/image.png"></div>
                            </div>

                            <!-- Subject Marks -->
                             <div class="mt-6 border-t pt-6">
                                <h3 class="text-lg font-medium text-gray-800">Subject Marks</h3>
                                <div id="subjects-container" class="mt-4 space-y-4"></div>
                                <button type="button" id="add-subject-btn" class="mt-4 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-plus mr-2"></i>Add Subject
                                </button>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="flex items-center gap-4 pt-6 border-t">
                                <button type="submit" id="submit-student-btn" class="inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                                    <span id="submit-student-btn-text">Save Student & Results</span><div id="student-loader" class="loader hidden ml-2"></div>
                                </button>
                                <button type="button" id="cancel-edit-btn" class="hidden py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Cancel Edit</button>
                            </div>
                        </form>
                        
                        <!-- Current Students List Section -->
                        <div class="mt-12">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Current Students</h3>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="w-full min-w-[600px]"><thead class="bg-gray-50"><tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"><th class="p-3">Photo</th><th class="p-3">Name</th><th class="p-3">Roll No.</th><th class="p-3">Class</th><th class="p-3">Actions</th></tr></thead><tbody id="students-list" class="bg-white divide-y divide-gray-200"></tbody></table>
                            </div>
                        </div>
                    </div>
                    <!-- Announcements Tab -->
                    <div id="announcements-tab" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg">
                        <div class="border-b pb-4 mb-6"><h2 class="text-2xl font-bold text-gray-800">Manage Announcements</h2><p class="text-gray-500">Create or delete school-wide announcements.</p></div>
                        <form id="announcement-form" class="space-y-4">
                            <div><label for="announcement-title" class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="announcement-title" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div>
                            <div><label for="announcement-content" class="block text-sm font-medium text-gray-700">Content</label><textarea id="announcement-content" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></textarea></div>
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Post Announcement</button>
                        </form>
                        <div class="mt-10"><h3 class="text-xl font-bold text-gray-800 mb-4">Posted Announcements</h3><div id="announcements-list-admin" class="space-y-4"></div></div>
                    </div>
                    <!-- Settings Tab -->
                    <div id="settings-tab" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg">
                        <div class="border-b pb-4 mb-6"><h2 class="text-2xl font-bold text-gray-800">School Settings</h2><p class="text-gray-500">Manage general school information and branding.</p></div>
                        <form id="settings-form" class="space-y-4 max-w-lg">
                            <div><label for="school-name-setting" class="block text-sm font-medium text-gray-700">School Name</label><input type="text" id="school-name-setting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="school-address-setting" class="block text-sm font-medium text-gray-700">School Address</label><input type="text" id="school-address-setting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="report-title-setting" class="block text-sm font-medium text-gray-700">Report Card Title</label><input type="text" id="report-title-setting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="session-setting" class="block text-sm font-medium text-gray-700">Session</label><input type="text" id="session-setting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="school-logo-url" class="block text-sm font-medium text-gray-700">School Logo URL</label><input type="url" id="school-logo-url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/logo.png"></div>
                            <div><label for="teacher-signature-url" class="block text-sm font-medium text-gray-700">Class Teacher's Signature URL</label><input type="url" id="teacher-signature-url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/teacher_sig.png"></div>
                            <div><label for="principal-signature-url" class="block text-sm font-medium text-gray-700">Principal's Signature URL</label><input type="url" id="principal-signature-url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/principal_sig.png"></div>
                            <div class="flex items-center gap-4">
                                <button type="submit" id="save-settings-btn" class="inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors"><span id="save-settings-btn-text">Save Settings</span><div id="settings-loader" class="loader hidden ml-2"></div></button>
                            </div>
                            <p id="settings-status" class="text-sm mt-2"></p>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 id="modal-title" class="text-xl font-bold mb-4">Confirm Action</h2><p id="modal-text" class="mb-6"></p><div class="flex justify-end gap-4"><button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button><button id="modal-confirm-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Confirm</button></div></div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, updateDoc, deleteDoc, getDoc, setDoc, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyC8TX2-inj8UwiRvU0UiZU8GxvXrDmsM2o",
            authDomain: "edumark-4d037.firebaseapp.com",
            projectId: "edumark-4d037",
            storageBucket: "edumark-4d037.appspot.com",
            messagingSenderId: "334521740799",
            appId: "1:334521740799:web:3630260b2b6deff91f0bca",
            measurementId: "G-0RVGLH1CCM"
        };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        
        const elements = { 
            loginScreen: document.getElementById('login-screen'), mainDashboard: document.getElementById('main-dashboard'), loginForm: document.getElementById('login-form'), loginError: document.getElementById('login-error'), logoutButton: document.getElementById('logout-button'), 
            totalStudentsCard: document.getElementById('total-students-card'), passedStudentsCard: document.getElementById('passed-students-card'), failedStudentsCard: document.getElementById('failed-students-card'),
            studentsList: document.getElementById('students-list'), 
            studentResultForm: document.getElementById('student-result-form'),
            studentIdInput: document.getElementById('student-id'), studentFormTitle: document.getElementById('student-form-title'), submitStudentBtn: document.getElementById('submit-student-btn'), submitStudentBtnText: document.getElementById('submit-student-btn-text'), studentLoader: document.getElementById('student-loader'), cancelEditBtn: document.getElementById('cancel-edit-btn'), 
            subjectsContainer: document.getElementById('subjects-container'), addSubjectBtn: document.getElementById('add-subject-btn'),
            announcementForm: document.getElementById('announcement-form'), announcementsListAdmin: document.getElementById('announcements-list-admin'), 
            confirmationModal: document.getElementById('confirmation-modal'), modalTitle: document.getElementById('modal-title'), modalText: document.getElementById('modal-text'), modalConfirmBtn: document.getElementById('modal-confirm-btn'), modalCancelBtn: document.getElementById('modal-cancel-btn'), 
            settingsForm: document.getElementById('settings-form'), settingsStatus: document.getElementById('settings-status'), saveSettingsBtn: document.getElementById('save-settings-btn'), settingsLoader: document.getElementById('settings-loader')
        };
        
        let isEditMode = false, studentsData = [], actionToConfirm = null;
        
        function showConfirmationModal(title, text, onConfirm) { elements.modalTitle.textContent = title; elements.modalText.textContent = text; actionToConfirm = onConfirm; elements.confirmationModal.classList.remove('hidden'); }
        function hideConfirmationModal() { elements.confirmationModal.classList.add('hidden'); actionToConfirm = null; }
        
        function resetStudentForm() { 
            isEditMode = false; 
            elements.studentResultForm.reset(); 
            elements.studentIdInput.value = ''; 
            elements.subjectsContainer.innerHTML = '';
            elements.studentFormTitle.textContent = 'Add New Student & Results'; 
            elements.submitStudentBtnText.textContent = 'Save Student & Results'; 
            elements.cancelEditBtn.classList.add('hidden'); 
        }
        
        async function calculateDashboardStats() {
            const studentsSnapshot = await getDocs(collection(db, "students"));
            const resultsSnapshot = await getDocs(collection(db, "results"));
            const totalStudents = studentsSnapshot.size;
            let passedCount = 0;
            resultsSnapshot.forEach(doc => {
                const result = doc.data();
                if (result.subjects && result.subjects.length > 0) {
                    let totalMarks = 0;
                    let obtainedMarks = 0;
                    result.subjects.forEach(sub => {
                        totalMarks += parseInt(sub.total, 10) || 0;
                        obtainedMarks += parseInt(sub.obtained, 10) || 0;
                    });
                    const percentage = totalMarks > 0 ? (obtainedMarks / totalMarks) * 100 : 0;
                    if (percentage >= 50) {
                        passedCount++;
                    }
                }
            });
            const failedCount = resultsSnapshot.size - passedCount;
            elements.totalStudentsCard.textContent = totalStudents;
            elements.passedStudentsCard.textContent = passedCount;
            elements.failedStudentsCard.textContent = failedCount;
        }

        function loadStudents() { 
            onSnapshot(query(collection(db, "students"), orderBy("name")), (snapshot) => { 
                elements.studentsList.innerHTML = ''; 
                studentsData = []; 
                snapshot.forEach(doc => { 
                    const student = { id: doc.id, ...doc.data() }; 
                    studentsData.push(student); 
                    const tr = document.createElement('tr'); 
                    const photoUrl = student.photoUrl || 'https://placehold.co/60x60/e2e8f0/e2e8f0?text='; 
                    tr.innerHTML = `<td class="p-3"><img src="${photoUrl}" alt="${student.name}" class="w-10 h-10 rounded-full object-cover"></td><td class="p-3 font-medium text-gray-900">${student.name}</td><td class="p-3 text-gray-500">${student.rollNumber}</td><td class="p-3 text-gray-500">${student.class}</td><td class="p-3 space-x-3"><button class="text-indigo-500 hover:underline edit-student" data-id="${doc.id}">Edit</button><button class="text-red-500 hover:underline delete-student" data-id="${doc.id}">Delete</button></td>`; 
                    elements.studentsList.appendChild(tr); 
                }); 
                calculateDashboardStats();
            }); 
        }
        
        function addSubjectInput(subject = { name: '', total: '', obtained: '' }) {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'grid grid-cols-1 sm:grid-cols-4 gap-4 items-center';
            subjectDiv.innerHTML = `
                <input type="text" placeholder="Subject Name" class="subject-name sm:col-span-2 mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" value="${subject.name}" required>
                <input type="number" placeholder="Total Marks" class="total-marks mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" value="${subject.total}" required>
                <input type="number" placeholder="Obtained Marks" class="obtained-marks mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" value="${subject.obtained}" required>
            `;
            elements.subjectsContainer.appendChild(subjectDiv);
        }

        function loadAnnouncements() { onSnapshot(query(collection(db, "announcements"), orderBy("createdAt", "desc")), snapshot => { elements.announcementsListAdmin.innerHTML = ''; snapshot.forEach(doc => { const ann = doc.data(); const div = document.createElement('div'); div.className = 'p-4 border rounded-lg flex justify-between items-start'; const date = ann.createdAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }); div.innerHTML = `<div><h4 class="font-bold text-gray-800">${ann.title}</h4><p class="text-gray-600 mt-1">${ann.content}</p><p class="text-xs text-gray-400 mt-2">${date}</p></div><button class="text-red-500 hover:underline delete-announcement-btn" data-id="${doc.id}">Delete</button>`; elements.announcementsListAdmin.appendChild(div); }); }); }
        
        async function loadSettings() { 
            const docSnap = await getDoc(doc(db, "settings", "schoolDetails")); 
            if (docSnap.exists()) { 
                const data = docSnap.data(); 
                document.getElementById('school-name-setting').value = data.name || 'EDUMARK'; 
                document.getElementById('school-address-setting').value = data.address || '123 Education Lane, Knowledge City, 12345';
                document.getElementById('report-title-setting').value = data.reportTitle || 'ANNUAL PROGRESS REPORT';
                document.getElementById('session-setting').value = data.session || 'SESSION: 2024-2025';
                document.getElementById('school-logo-url').value = data.logoUrl || 'https://i.ibb.co/mCP7MD6m/image-20250927-120756-0000.png'; 
                document.getElementById('teacher-signature-url').value = data.teacherSignatureUrl || ''; 
                document.getElementById('principal-signature-url').value = data.principalSignatureUrl || ''; 
            } else { 
                document.getElementById('school-name-setting').value = 'EDUMARK'; 
                document.getElementById('school-address-setting').value = '123 Education Lane, Knowledge City, 12345';
                document.getElementById('report-title-setting').value = 'ANNUAL PROGRESS REPORT';
                document.getElementById('session-setting').value = 'SESSION: 2024-2025';
                document.getElementById('school-logo-url').value = 'https://i.ibb.co/mCP7MD6m/image-20250927-120756-0000.png'; 
            } 
        }
        
        function updateClock() {
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if (timeEl && dateEl) {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                dateEl.textContent = now.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        onAuthStateChanged(auth, user => { 
            if (user) { 
                elements.loginScreen.classList.add('hidden'); 
                elements.mainDashboard.classList.remove('hidden'); 
                loadStudents(); 
                loadAnnouncements(); 
                loadSettings(); 
                updateClock();
                setInterval(updateClock, 1000);
            } else { 
                elements.loginScreen.classList.remove('hidden'); 
                elements.mainDashboard.classList.add('hidden'); 
            } 
        });
        
        elements.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(error => {
                    if (error.code === 'auth/invalid-credential') {
                        elements.loginError.textContent = 'Invalid Credentials. Please check your email and password.';
                    } else {
                        elements.loginError.textContent = 'An unknown error occurred. Please try again later.';
                        console.error('Login Error:', error);
                    }
                });
        });

        elements.logoutButton.addEventListener('click', () => signOut(auth));
        elements.modalCancelBtn.addEventListener('click', hideConfirmationModal);
        elements.modalConfirmBtn.addEventListener('click', async () => { if (actionToConfirm) await actionToConfirm(); hideConfirmationModal(); });
        document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', () => { document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden')); document.getElementById(`${button.dataset.tab}-tab`).classList.remove('hidden'); }));
        
        elements.studentResultForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentData = { 
                name: document.getElementById('student-name').value, 
                fatherName: document.getElementById('father-name').value, 
                rollNumber: document.getElementById('roll-number').value, 
                class: document.getElementById('student-class').value, 
                photoUrl: document.getElementById('student-photo-url').value || null 
            };

            const subjects = [];
            document.querySelectorAll('#subjects-container .grid').forEach(div => {
                const name = div.querySelector('.subject-name').value;
                const total = div.querySelector('.total-marks').value;
                const obtained = div.querySelector('.obtained-marks').value;
                if (name && total && obtained) {
                    subjects.push({ name, total, obtained });
                }
            });

            elements.submitStudentBtn.disabled = true;
            elements.studentLoader.classList.remove('hidden');

            try {
                let studentId = elements.studentIdInput.value;
                if (isEditMode) {
                    await updateDoc(doc(db, "students", studentId), studentData);
                } else {
                    const docRef = await addDoc(collection(db, "students"), studentData);
                    studentId = docRef.id;
                }
                
                await setDoc(doc(db, "results", studentId), { subjects });
                
                resetStudentForm();
                await calculateDashboardStats();

            } catch (error) {
                console.error("Error saving data:", error);
            } finally {
                elements.submitStudentBtn.disabled = false;
                elements.studentLoader.classList.add('hidden');
            }
        });

        elements.studentsList.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('edit-student')) {
                const studentId = target.dataset.id;
                const student = studentsData.find(s => s.id === studentId);
                if (student) {
                    document.getElementById('student-name').value = student.name;
                    document.getElementById('father-name').value = student.fatherName || '';
                    document.getElementById('roll-number').value = student.rollNumber;
                    document.getElementById('student-class').value = student.class;
                    document.getElementById('student-photo-url').value = student.photoUrl || '';
                    elements.studentIdInput.value = student.id;
                    isEditMode = true;
                    elements.studentFormTitle.textContent = 'Edit Student & Results';
                    elements.submitStudentBtnText.textContent = 'Update Student & Results';
                    elements.cancelEditBtn.classList.remove('hidden');

                    elements.subjectsContainer.innerHTML = '';
                    const resultDoc = await getDoc(doc(db, "results", studentId));
                    if (resultDoc.exists()) {
                        resultDoc.data().subjects.forEach(subject => addSubjectInput(subject));
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
            if (target.classList.contains('delete-student')) {
                showConfirmationModal('Confirm Deletion', 'Are you sure you want to delete this student and their result?', async () => {
                    await deleteDoc(doc(db, "students", target.dataset.id));
                    await deleteDoc(doc(db, "results", target.dataset.id));
                    await calculateDashboardStats();
                });
            }
        });
        
        elements.cancelEditBtn.addEventListener('click', resetStudentForm);
        elements.addSubjectBtn.addEventListener('click', () => addSubjectInput());
        elements.announcementForm.addEventListener('submit', async (e) => { e.preventDefault(); await addDoc(collection(db, "announcements"), { title: document.getElementById('announcement-title').value, content: document.getElementById('announcement-content').value, createdAt: new Date() }); elements.announcementForm.reset(); });
        elements.announcementsListAdmin.addEventListener('click', e => { if (e.target.classList.contains('delete-announcement-btn')) { showConfirmationModal('Confirm Deletion', 'Are you sure you want to delete this announcement?', () => deleteDoc(doc(db, "announcements", e.target.dataset.id))); } });
        
        elements.settingsForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const { settingsStatus, saveSettingsBtn, settingsLoader } = elements; 
            settingsStatus.textContent = 'Saving...'; 
            settingsStatus.style.color = 'gray'; 
            saveSettingsBtn.disabled = true; 
            settingsLoader.classList.remove('hidden'); 
            const settingsData = { 
                name: document.getElementById('school-name-setting').value, 
                address: document.getElementById('school-address-setting').value,
                reportTitle: document.getElementById('report-title-setting').value,
                session: document.getElementById('session-setting').value,
                logoUrl: document.getElementById('school-logo-url').value, 
                teacherSignatureUrl: document.getElementById('teacher-signature-url').value, 
                principalSignatureUrl: document.getElementById('principal-signature-url').value 
            }; 
            try { 
                await setDoc(doc(db, "settings", "schoolDetails"), settingsData, { merge: true }); 
                settingsStatus.textContent = 'Settings saved successfully!'; 
                settingsStatus.style.color = 'green'; 
            } catch (error) { 
                console.error(error); 
                settingsStatus.textContent = 'Error saving settings.'; 
                settingsStatus.style.color = 'red'; 
            } finally { 
                saveSettingsBtn.disabled = false; 
                settingsLoader.classList.add('hidden'); 
                setTimeout(() => { settingsStatus.textContent = ''; }, 3000); 
            } 
        });
    </script>
</body>
</html>
